name: iOS Build & Release

permissions:
  contents: write   # REQUIRED for GitHub Releases

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    name: Build iOS and Publish GitHub Release

    steps:
      # ---------------------------
      # Checkout source
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # Select Xcode (safe)
      # ---------------------------
      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app || true
          xcodebuild -version

      # ---------------------------
      # Detect workspace/project + shared scheme
      # ---------------------------
      - name: Detect Xcode project and scheme
        run: |
          set -e

          if ls *.xcworkspace 1> /dev/null 2>&1; then
            FILETYPE="workspace"
            FILE=$(ls *.xcworkspace | head -n 1)
          else
            FILETYPE="project"
            FILE=$(ls *.xcodeproj | head -n 1)
          fi

          echo "Using $FILETYPE: $FILE"

          SCHEME=$(xcodebuild -list -"$FILETYPE" "$FILE" | \
            sed -n '/Schemes:/,$p' | tail -n +2 | sed 's/^ *//' | head -n 1)

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No shared scheme found"
            exit 1
          fi

          echo "Detected scheme: $SCHEME"

          echo "FILETYPE=$FILETYPE" >> $GITHUB_ENV
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      # ---------------------------
      # Build app (SIMULATOR)
      # ---------------------------
      - name: Build iOS app (Simulator)
        run: |
          set -e

          mkdir -p build

          xcodebuild clean build \
            -"$FILETYPE" "$FILE" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=iPhone 14" \
            -derivedDataPath build

      # ---------------------------
      # Package app (correct way)
      # ---------------------------
      - name: Package app
        run: |
          set -e

          APP_PATH=$(find build -name "*.app" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "‚ùå .app not found"
            exit 1
          fi

          mkdir -p output
          ditto -c -k --sequesterRsrc --keepParent \
            "$APP_PATH" output/App.app.zip

          echo "Packaged: output/App.app.zip"

      # ---------------------------
      # Publish GitHub Release
      # ---------------------------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Simulator Build v1.0.${{ github.run_number }}
          body: |
            üöÄ Automated iOS Simulator Build

            **Scheme:** ${{ env.SCHEME }}
            **Commit:** ${{ github.sha }}

            ‚ö†Ô∏è Simulator build (not installable on real devices)
          files: output/App.app.zip
