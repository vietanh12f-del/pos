name: iOS Build & Release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    name: Build iOS and Publish GitHub Release

    steps:
      # ---------------------------
      # Checkout source
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # Select Xcode (Xcode 16 safe)
      # ---------------------------
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      # ---------------------------
      # Detect workspace/project + shared scheme
      # ---------------------------
      - name: Detect Xcode project and scheme
        run: |
          set -e

          # Detect workspace or project (pick ONE)
          if find . -maxdepth 1 -name "*.xcworkspace" | grep -q .; then
            FILETYPE="workspace"
            FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          else
            FILETYPE="project"
            FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -n 1)
          fi

          echo "Using $FILETYPE: $FILE"

          # Detect shared scheme (CI-safe)
          SCHEME=$(xcodebuild -list -"$FILETYPE" "$FILE" | \
            sed -n '/Schemes:/,$p' | \
            tail -n +2 | \
            sed 's/^ *//' | \
            grep -v '^$' | \
            head -n 1)

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No shared scheme found."
            echo "üëâ Xcode ‚Üí Product ‚Üí Scheme ‚Üí Manage Schemes ‚Üí Share"
            exit 1
          fi

          echo "Detected scheme: $SCHEME"

          echo "FILETYPE=$FILETYPE" >> $GITHUB_ENV
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      # ---------------------------
      # Build app (CI-safe simulator)
      # ---------------------------
      - name: Build iOS app
        run: |
          set -e

          echo "Building with Any iOS Simulator Device"

          mkdir -p build

          xcodebuild \
            -scheme "$SCHEME" \
            -"$FILETYPE" "$FILE" \
            -destination "platform=iOS Simulator,name=iPhone 16" \
            -derivedDataPath build \
            clean build

      # ---------------------------
      # Package IPA (simulator build)
      # ---------------------------
      - name: Package IPA
        run: |
          set -e

          cd build/Build/Products
          APP=$(find . -name "*.app" | head -n 1)

          if [ -z "$APP" ]; then
            echo "‚ùå .app not found"
            exit 1
          fi

          echo "Packaging $APP"

          zip -r ../../../App.ipa "$APP"

      # ---------------------------
      # Publish GitHub Release (PUBLIC LINK)
      # ---------------------------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Build v1.0.${{ github.run_number }}
          body: |
            üöÄ Automated iOS build

            **Scheme:** ${{ env.SCHEME }}
            **Commit:** ${{ github.sha }}
          files: App.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
