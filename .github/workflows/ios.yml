name: iOS Build & Release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS IPA and Publish GitHub Release
    runs-on: macos-latest

    steps:
      # ---------------------------
      # Checkout source
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # Select Xcode version (optional but recommended)
      # ---------------------------
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      # ---------------------------
      # Detect default scheme
      # ---------------------------
      - name: Detect default scheme
        run: |
          scheme_list=$(xcodebuild -list -json | tr -d "\n")
          default_scheme=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
          echo "SCHEME=$default_scheme" >> $GITHUB_ENV
          echo "Using scheme: $default_scheme"

      # ---------------------------
      # Build IPA (Simulator-safe demo build)
      # NOTE: For real devices, signing is required
      # ---------------------------
      - name: Build IPA
        env:
          SCHEME: ${{ env.SCHEME }}
        run: |
          set -e

          DEVICE=$(xcrun xctrace list devices 2>&1 | grep -oE 'iPhone.*?[^\(]+' | head -1 | sed 's/ Simulator$//')
          PLATFORM="iOS Simulator"

          if ls *.xcworkspace 1> /dev/null 2>&1; then
            FILETYPE="workspace"
            FILE=$(ls *.xcworkspace)
          else
            FILETYPE="project"
            FILE=$(ls *.xcodeproj)
          fi

          mkdir -p build

          xcodebuild \
            -scheme "$SCHEME" \
            -"$FILETYPE" "$FILE" \
            -destination "platform=$PLATFORM,name=$DEVICE" \
            -derivedDataPath build \
            clean build

          # Fake IPA for demo purposes (simulator builds can't be exported as real IPA)
          cd build/Build/Products
          APP=$(find . -name "*.app" | head -1)
          zip -r ../../../App.ipa "$APP"

      # ---------------------------
      # Create GitHub Release + upload IPA
      # ---------------------------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Build v1.0.${{ github.run_number }}
          body: |
            ðŸš€ Automated iOS build from GitHub Actions

            **Commit:** ${{ github.sha }}
          files: |
            App.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
