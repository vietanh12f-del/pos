name: iOS Build & Release

permissions:
  contents: write

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    name: Build iOS and Publish GitHub Release

    steps:
      # ---------------------------
      # Checkout
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------
      # Select Xcode
      # ---------------------------
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      # ---------------------------
      # Detect REAL Xcode project/workspace + shared scheme
      # ---------------------------
      - name: Detect Xcode project and scheme
        shell: bash
        run: |
          set -e

          # Prefer workspace, only DIRECTORY bundles
          WORKSPACE=$(find . -maxdepth 2 -type d -name "*.xcworkspace" | head -n 1)
          PROJECT=$(find . -maxdepth 2 -type d -name "*.xcodeproj" | head -n 1)

          if [ -n "$WORKSPACE" ]; then
            FILETYPE="workspace"
            FILE="$WORKSPACE"
          elif [ -n "$PROJECT" ]; then
            FILETYPE="project"
            FILE="$PROJECT"
          else
            echo "‚ùå No .xcworkspace or .xcodeproj directory found"
            exit 1
          fi

          echo "Using $FILETYPE: $FILE"

          # Detect SHARED scheme only
          SCHEME=$(xcodebuild -list -"$FILETYPE" "$FILE" | \
            awk '/Schemes:/ {found=1; next} found && NF {print $1; exit}')

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No shared scheme found"
            echo "üëâ Xcode ‚Üí Product ‚Üí Scheme ‚Üí Manage Schemes ‚Üí check ‚úÖ Shared"
            exit 1
          fi

          echo "Detected scheme: $SCHEME"

          echo "FILETYPE=$FILETYPE" >> $GITHUB_ENV
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      # ---------------------------
      # Build (SIMULATOR-SAFE)
      # ---------------------------
      - name: Build iOS app
        shell: bash
        run: |
          set -e

          mkdir -p build

          echo "Building with generic iOS Simulator"

          xcodebuild \
            -scheme "$SCHEME" \
            -"$FILETYPE" "$FILE" \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath build \
            clean build

      # ---------------------------
      # Package IPA (simulator)
      # ---------------------------
      - name: Package IPA
        shell: bash
        run: |
          set -e

          APP=$(find build/Build/Products -type d -name "*.app" | head -n 1)

          if [ -z "$APP" ]; then
            echo "‚ùå .app not found"
            exit 1
          fi

          echo "Packaging $APP"

          mkdir -p output
          cd "$(dirname "$APP")"
          zip -r ../../../output/App.ipa "$(basename "$APP")"

      # ---------------------------
      # Publish GitHub Release
      # ---------------------------
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Build v1.0.${{ github.run_number }}
          body: |
            üöÄ Automated iOS Simulator Build

            **Scheme:** ${{ env.SCHEME }}
            **Commit:** ${{ github.sha }}
          files: output/App.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
