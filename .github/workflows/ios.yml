name: iOS Build & Release (Simulator)

permissions:
  contents: write  # for GitHub Releases

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    name: Build iOS (Simulator) and Publish Release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # If you need a specific Xcode version, pin it; otherwise macos-latest default is fine.
      - name: Select Xcode 16.4 (optional)
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Detect Xcode project and scheme
        run: |
          set -e
          if find . -maxdepth 1 -name "*.xcworkspace" | grep -q .; then
            FILETYPE="workspace"
            FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          else
            FILETYPE="project"
            FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -n 1)
          fi
          echo "Using $FILETYPE: $FILE"
          SCHEME=$(xcodebuild -list -"$FILETYPE" "$FILE" | sed -n '/Schemes:/,$p' | tail -n +2 | sed 's/^ *//' | grep -v '^$' | head -n 1)
          if [ -z "$SCHEME" ]; then
            echo "‚ùå No shared scheme found."
            echo "üëâ Xcode ‚Üí Product ‚Üí Scheme ‚Üí Manage Schemes ‚Üí Share"
            exit 1
          fi
          echo "Detected scheme: $SCHEME"
          echo "FILETYPE=$FILETYPE" >> $GITHUB_ENV
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: Build (Generic iOS Simulator, signing disabled)
        run: |
          set -e
          mkdir -p build
          xcodebuild \
            -scheme "$SCHEME" \
            -"$FILETYPE" "$FILE" \
            -destination "generic/platform=iOS Simulator" \
            -configuration Debug \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            clean build \
            -derivedDataPath build

      - name: Package Simulator App (.zip)
        run: |
          set -e
          cd build/Build/Products
          # Prefer Debug-iphonesimulator path
          APP=$(find . -type d -path "*-iphonesimulator/*.app" | head -n 1)
          if [ -z "$APP" ]; then
            APP=$(find . -name "*.app" | head -n 1)
          fi
          if [ -z "$APP" ]; then
            echo "‚ùå .app not found"
            exit 1
          fi
          echo "Found app: $APP"
          cd "$(dirname "$APP")"
          APPNAME=$(basename "$APP")
          zip -r "../../../${APPNAME%.app}-simulator.zip" "$APPNAME"
          cd -
          ls -lah ../../..
          
      - name: Publish GitHub Release (attach simulator app zip)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Simulator Build v1.0.${{ github.run_number }}
          body: |
            üöÄ Automated iOS **Simulator** build
            ‚ö†Ô∏è Simulator-only build (not installable on real devices)
            **Scheme:** ${{ env.SCHEME }}
            **Commit:** ${{ github.sha }}
          files: "/Users/runner/work/pos/pos/build/Build/Products/Debug-iphonesimulator/kiot.app"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

