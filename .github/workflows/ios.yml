name: iOS Build & Release (Simulator)

permissions:
  contents: write  # for GitHub Releases

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    name: Build iOS (Simulator) and Publish Release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # If you need a specific Xcode version, pin it; otherwise macos-latest default is fine.
      - name: Select Xcode 16.4 (optional)
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Detect Xcode project and scheme
        run: |
          set -e
          if find . -maxdepth 1 -name "*.xcworkspace" | grep -q .; then
            FILETYPE="workspace"
            FILE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          else
            FILETYPE="project"
            FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -n 1)
          fi
          echo "Using $FILETYPE: $FILE"
          SCHEME=$(xcodebuild -list -"$FILETYPE" "$FILE" | sed -n '/Schemes:/,$p' | tail -n +2 | sed 's/^ *//' | grep -v '^$' | head -n 1)
          if [ -z "$SCHEME" ]; then
            echo "âŒ No shared scheme found."
            echo "ðŸ‘‰ Xcode â†’ Product â†’ Scheme â†’ Manage Schemes â†’ Share"
            exit 1
          fi
          echo "Detected scheme: $SCHEME"
          echo "FILETYPE=$FILETYPE" >> $GITHUB_ENV
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV
      # Build (Generic iOS Simulator)
      - name: Build (Generic iOS Simulator, signing disabled)
        run: |
          set -e
          mkdir -p build
          xcodebuild \
            -scheme "$SCHEME" \
            -"$FILETYPE" "$FILE" \
            -destination "generic/platform=iOS Simulator" \
            -configuration Debug \
            -sdk iphonesimulator \
            IPHONEOS_DEPLOYMENT_TARGET=16.0 \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            clean build \
            -derivedDataPath build
      
      # Package Simulator App (.zip)
      - name: Package Simulator App
        run: |
          set -e
          cd build/Build/Products
          # Prefer Debug-iphonesimulator
          APP=$(find . -type d -path "*-iphonesimulator/*.app" | head -n 1)
          if [ -z "$APP" ]; then
            APP=$(find . -name "*.app" | head -n 1)
          fi
          if [ -z "$APP" ]; then
            echo "âŒ .app not found"
            exit 1
          fi
          echo "Found app: $APP"
          cd "$(dirname "$APP")"
          APPNAME=$(basename "$APP")
          ZIP_NAME="${APPNAME%.app}-simulator.zip"
          zip -r "../../../$ZIP_NAME" "$APPNAME"
          cd -
          ls -lah ../../..
          echo "SIM_ZIP=build/Build/Products/$ZIP_NAME" >> $GITHUB_ENV
      
      # Upload as Actions artifact (handy for quick downloads)
      - name: Upload simulator app artifact
        uses: actions/upload-artifact@v4
        with:
          name: kiot-simulator
          path: ${{ env.SIM_ZIP }}
          if-no-files-found: error
      
      # Publish GitHub Release (attach simulator zip)
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: iOS Simulator Build v1.0.${{ github.run_number }}
          body: |
            ðŸš€ Automated iOS **Simulator** build
      
            **Scheme:** ${{ env.SCHEME }}
            **Commit:** ${{ github.sha }}
          files: ${{ env.SIM_ZIP }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
